const fs = require("fs")
const jsdoc2md = require('jsdoc-to-markdown')
const ccc = require("clear_concise_creative")
const automate_me = require("automate_me")
const { see } = require("code_clarity")

function replaceJSDOCLink(moduleName) {
    ccc.addToNestedJSON("./node_modules/explain_me/jsdoc.json", ["opts", "theme_opts", "menu"], {
        "title": "see npm package",
        "link": `https://www.npmjs.com/package/${moduleName}`,
        "target": "_blank"
    })
    ccc.replaceJSON("./node_modules/explain_me/jsdoc.json", ["opts", "theme_opts", "codepen"], {
        "enable_for": [
            "examples"
        ],
        "options": {
            "js_external": `https://cdn.jsdelivr.net/npm/${moduleName}`,
        }
    })
}

function replaceJSDOCVideo(video) {
    ccc.addToNestedJSON("./node_modules/explain_me/jsdoc.json", ["opts", "theme_opts", "menu"], {
        "title": "visual instructions",
        "link": video,
        "target": "_blank"
    })
}

function readme(moduleName = undefined, video = undefined) {
    let badges = ""
    let getData = jsdoc2md.renderSync({ files: "src/**.js" })
    if (moduleName) {
        badges += `# ${moduleName}`
        badges += "\n[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)" + `\n![NPM Downloads](https://img.shields.io/npm/dw/${moduleName})`
        badges += "## Instructions: \n```" + `npm install ${moduleName}` + " ``` \n ``` " + `\nconst ${moduleName}` + " =  " + `require('${moduleName}')` + "```\n"

    }
    if (video) {
        badges += `[![here](${video})](${video})`
    }
    let data = badges + "\n" + getData;
    ccc.appendFile("./README.md", data)
}



function html(moduleName = undefined, video = undefined) {

    if (moduleName) {
        replaceJSDOCLink(moduleName)
    }
    if (video) {
        replaceJSDOCVideo(video)
    }
    let getJSDOC = ccc.readJSON("./node_modules/explain_me/jsdoc.json")
    ccc.writeJSON("./jsdoc.json", getJSDOC)
    automate_me.runCommand(`rm -rf docs && ./node_modules/.bin/jsdoc --configure ./jsdoc.json -d docs --verbose`)
}

function addScript(moduleName = undefined) {
    if (moduleName) {
        ccc.appendToJSON("./package.json", "homepage", `https://zen-out.github.io/packages/${moduleName}`)
        ccc.appendToJSON("./package.json", "repository", `https://github.com/zen-out/${moduleName}`)
    }
    ccc.mergeJSONObject("./package.json", ["scripts"], {
        "docs": "rm -rf docs && ./node_modules/.bin/jsdoc --configure ./jsdoc.json -d docs --verbose",
        "play": "node playground.js",
        "test": "node __tests__/index.js",
        "deploy": "npm run test && git add . && git commit -m 'updated' && git push && npm version patch && npm publish",
    })
}

module.exports = { html, readme, addScript }